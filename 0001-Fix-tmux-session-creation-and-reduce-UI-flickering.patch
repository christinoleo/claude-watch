From fa66db28907f19e1d79625cd49ab69e5edce7abb Mon Sep 17 00:00:00 2001
From: John Robinson <jrobinson@alarm.com>
Date: Tue, 27 Jan 2026 15:23:38 -0500
Subject: [PATCH] Fix tmux session creation and reduce UI flickering

- Fix npx . not staying in watch session by creating session first then
  sending command via send-keys instead of passing command to new-session
- Auto-create data directories on startup instead of requiring --setup
- Only update React state when session data actually changes
- Move blink logic to self-contained BlinkingBullet component

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
---
 src/app.tsx                     | 27 ++++++++++++-----------
 src/cli.ts                      | 20 ++++++++---------
 src/components/SessionEntry.tsx | 38 ++++++++++++++++++++++-----------
 src/components/SessionList.tsx  |  4 +---
 4 files changed, 51 insertions(+), 38 deletions(-)

diff --git a/src/app.tsx b/src/app.tsx
index b788a54..05501c9 100644
--- a/src/app.tsx
+++ b/src/app.tsx
@@ -13,7 +13,6 @@ import { switchToTarget } from "./tmux/navigate.js";
 import { capturePaneContent, detectRecentInterruption } from "./tmux/pane.js";
 
 const POLL_INTERVAL = 500; // ms
-const BLINK_INTERVAL = 500; // ms
 const CLEANUP_INTERVAL = 5000; // ms
 const PANE_CHECK_INTERVAL = 2000; // ms - check tmux panes for prompt
 
@@ -23,7 +22,6 @@ export function App() {
   const [sessions, setSessions] = useState<Session[]>([]);
   const [tmuxSessions, setTmuxSessions] = useState<TmuxSession[]>([]);
   const [selectedIndex, setSelectedIndex] = useState(0);
-  const [showBlink, setShowBlink] = useState(true);
   const [inTmux] = useState(() => isInTmux());
   const [currentTmuxSession] = useState(() => getTmuxSessionName());
 
@@ -35,13 +33,25 @@ export function App() {
   const loadSessions = useCallback(() => {
     try {
       const loadedSessions = getAllSessions();
-      setSessions(loadedSessions);
+
+      // Only update if sessions have changed (compare by JSON to detect actual changes)
+      setSessions((prev) => {
+        const prevJson = JSON.stringify(prev);
+        const newJson = JSON.stringify(loadedSessions);
+        return prevJson === newJson ? prev : loadedSessions;
+      });
 
       // Also load tmux sessions (excluding the current session where claude-watch runs)
       const loadedTmuxSessions = getAllTmuxSessions().filter(
         (ts) => ts.name !== currentTmuxSession
       );
-      setTmuxSessions(loadedTmuxSessions);
+
+      // Only update if tmux sessions have changed
+      setTmuxSessions((prev) => {
+        const prevJson = JSON.stringify(prev);
+        const newJson = JSON.stringify(loadedTmuxSessions);
+        return prevJson === newJson ? prev : loadedTmuxSessions;
+      });
 
       // Adjust selected index if out of bounds
       const totalCount = getTotalItemCount(loadedSessions, loadedTmuxSessions);
@@ -60,14 +70,6 @@ export function App() {
     return () => clearInterval(interval);
   }, [loadSessions]);
 
-  // Blink effect for busy sessions
-  useEffect(() => {
-    const interval = setInterval(() => {
-      setShowBlink((prev) => !prev);
-    }, BLINK_INTERVAL);
-    return () => clearInterval(interval);
-  }, []);
-
   // Cleanup stale sessions periodically
   useEffect(() => {
     const cleanup = () => {
@@ -170,7 +172,6 @@ export function App() {
           sessions={sessions}
           tmuxSessions={tmuxSessions}
           selectedIndex={selectedIndex}
-          showBlink={showBlink}
           width={terminalWidth - 2}
         />
       </Box>
diff --git a/src/cli.ts b/src/cli.ts
index 91c24b4..6624494 100644
--- a/src/cli.ts
+++ b/src/cli.ts
@@ -4,13 +4,13 @@ import { program } from "commander";
 import { render } from "ink";
 import React from "react";
 import { execSync } from "child_process";
-import { existsSync, writeFileSync, unlinkSync, readFileSync } from "fs";
+import { existsSync, writeFileSync, unlinkSync, readFileSync, mkdirSync } from "fs";
 import { createInterface } from "readline";
 import { App } from "./app.js";
 import { runSetup, runCleanup } from "./setup/index.js";
 import { isInTmux, getTmuxSessionName } from "./tmux/detect.js";
 import { join } from "path";
-import { CLAUDE_WATCH_DIR } from "./utils/paths.js";
+import { CLAUDE_WATCH_DIR, SESSIONS_DIR } from "./utils/paths.js";
 import { isPidAlive } from "./utils/pid.js";
 import { VERSION } from "./utils/version.js";
 import {
@@ -110,8 +110,9 @@ program
           // Switch to the session
           execSync(`tmux switch-client -t ${WATCH_SESSION}`, { stdio: "inherit" });
         } else {
-          // Session doesn't exist, create it with claude-watch running
-          execSync(`tmux new-session -d -s ${WATCH_SESSION} ${escapeArg(fullCmd)}`, { stdio: "ignore" });
+          // Session doesn't exist, create it then send the command
+          execSync(`tmux new-session -d -s ${WATCH_SESSION}`, { stdio: "ignore" });
+          execSync(`tmux send-keys -t ${WATCH_SESSION} ${escapeArg(fullCmd)} Enter`, { stdio: "ignore" });
           execSync(`tmux switch-client -t ${WATCH_SESSION}`, { stdio: "inherit" });
         }
       } catch (error) {
@@ -124,13 +125,12 @@ program
 
     // We're in the watch session, run the TUI
 
-    // Check if setup has been run
+    // Auto-create data directories if needed
     if (!existsSync(CLAUDE_WATCH_DIR)) {
-      console.error("claude-watch has not been set up yet.");
-      console.error("");
-      console.error("Run the setup wizard first:");
-      console.error("  claude-watch --setup");
-      process.exit(1);
+      mkdirSync(CLAUDE_WATCH_DIR, { recursive: true });
+    }
+    if (!existsSync(SESSIONS_DIR)) {
+      mkdirSync(SESSIONS_DIR, { recursive: true });
     }
 
     // Check hooks version and prompt if needed
diff --git a/src/components/SessionEntry.tsx b/src/components/SessionEntry.tsx
index f903b43..1e505c6 100644
--- a/src/components/SessionEntry.tsx
+++ b/src/components/SessionEntry.tsx
@@ -1,8 +1,28 @@
-import React from "react";
+import React, { useState, useEffect } from "react";
 import { Box, Text } from "ink";
 import type { Session, SessionState } from "../db/index.js";
 import type { TmuxSession } from "../tmux/detect.js";
 
+const BLINK_INTERVAL = 500;
+
+// Self-contained blinking bullet - only this component re-renders during blink
+function BlinkingBullet({ color, shouldBlink }: { color: string; shouldBlink: boolean }) {
+  const [visible, setVisible] = useState(true);
+
+  useEffect(() => {
+    if (!shouldBlink) {
+      setVisible(true);
+      return;
+    }
+    const interval = setInterval(() => {
+      setVisible((prev) => !prev);
+    }, BLINK_INTERVAL);
+    return () => clearInterval(interval);
+  }, [shouldBlink]);
+
+  return <Text color={color}>{visible ? "●" : " "}</Text>;
+}
+
 // Unified display item - either a Claude session or a plain tmux session
 export type DisplayItem =
   | { type: "claude"; session: Session }
@@ -11,7 +31,6 @@ export type DisplayItem =
 interface SessionEntryProps {
   item: DisplayItem;
   isSelected: boolean;
-  showBlink?: boolean;
   width?: number;
 }
 
@@ -63,9 +82,9 @@ function truncatePath(path: string, maxLen: number): string {
   return "…" + path.slice(-(maxLen - 1));
 }
 
-export function SessionEntry({ item, isSelected, showBlink = true, width }: SessionEntryProps) {
+export function SessionEntry({ item, isSelected, width }: SessionEntryProps) {
   if (item.type === "claude") {
-    return <ClaudeEntry session={item.session} isSelected={isSelected} showBlink={showBlink} width={width} />;
+    return <ClaudeEntry session={item.session} isSelected={isSelected} width={width} />;
   } else {
     return <TmuxEntry tmuxSession={item.tmuxSession} isSelected={isSelected} width={width} />;
   }
@@ -74,19 +93,14 @@ export function SessionEntry({ item, isSelected, showBlink = true, width }: Sess
 function ClaudeEntry({
   session,
   isSelected,
-  showBlink,
   width,
 }: {
   session: Session;
   isSelected: boolean;
-  showBlink: boolean;
   width?: number;
 }) {
   const stateColor = getStateColor(session.state);
-  const bullet = "●";
-
-  // For busy state, we alternate visibility to create a blink effect
-  const shouldShowBullet = session.state !== "busy" || showBlink;
+  const shouldBlink = session.state === "busy";
 
   const tmuxTarget = session.tmux_target || "—";
 
@@ -105,8 +119,8 @@ function ClaudeEntry({
     <Box width={width}>
       {/* Selection indicator (▶ is wide, takes 2 cols) or 2 spaces */}
       <Text color="cyan" bold>{isSelected ? "▶" : "  "}</Text>
-      {/* Bullet in column 4 */}
-      <Text color={stateColor}>{shouldShowBullet ? bullet : " "}</Text>
+      {/* Bullet in column 4 - self-contained blink logic */}
+      <BlinkingBullet color={stateColor} shouldBlink={shouldBlink} />
       <Text>{" "}</Text>
 
       {/* tmux target */}
diff --git a/src/components/SessionList.tsx b/src/components/SessionList.tsx
index 51efa25..3b51057 100644
--- a/src/components/SessionList.tsx
+++ b/src/components/SessionList.tsx
@@ -8,11 +8,10 @@ interface SessionListProps {
   sessions: Session[];
   tmuxSessions: TmuxSession[];
   selectedIndex: number;
-  showBlink: boolean;
   width?: number;
 }
 
-export function SessionList({ sessions, tmuxSessions, selectedIndex, showBlink, width }: SessionListProps) {
+export function SessionList({ sessions, tmuxSessions, selectedIndex, width }: SessionListProps) {
   // Get tmux session names that have Claude instances
   const claudeTmuxSessions = new Set<string>();
   for (const session of sessions) {
@@ -49,7 +48,6 @@ export function SessionList({ sessions, tmuxSessions, selectedIndex, showBlink,
           key={item.type === "claude" ? item.session.id : `tmux-${item.tmuxSession.name}`}
           item={item}
           isSelected={index === selectedIndex}
-          showBlink={showBlink}
           width={width}
         />
       ))}
-- 
2.25.1

